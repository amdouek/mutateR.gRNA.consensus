% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/SHAP_analysis.R
\name{analyze_feature_importance}
\alias{analyze_feature_importance}
\title{Run SHAP analysis for gRNA features}
\usage{
analyze_feature_importance(
  batch_result,
  target = "quality_percentile_modern",
  modern_methods = c("deepspcas9", "deephf", "ruleset3"),
  legacy_methods = c("ruleset1"),
  n_top_features = 20,
  xgb_params = NULL,
  rasterize = NULL,
  raster_dpi = 300,
  subsample_beeswarm = NULL,
  quiet = FALSE
)
}
\arguments{
\item{batch_result}{A mutateR_consensus_batch or mutateR_consensus_analysis object}

\item{target}{Character. Target variable to model. Common options:
\describe{
\item{"quality_percentile_modern"}{Modern method consensus (recommended primary)}
\item{"quality_percentile_robust"}{Outlier-resistant quality}
\item{"discordance_modern"}{Disagreement across modern methods}
\item{"ruleset1_divergence"}{Legacy method divergence}
\item{"score_\if{html}{\out{<method>}}"}{Individual method score}
}}

\item{modern_methods}{Character vector of modern scoring methods.
Default: c("deepspcas9", "deephf", "ruleset3")}

\item{legacy_methods}{Character vector of legacy scoring methods.
Default: c("ruleset1")}

\item{n_top_features}{Integer. Number of top features to display (default 20)}

\item{xgb_params}{List. XGBoost parameters (optional, uses sensible defaults)}

\item{rasterize}{Logical. Rasterise beeswarm points for large datasets.
Default NULL means auto-determine (TRUE if n > 5000).}

\item{raster_dpi}{Integer. DPI for rasterized layers (default 300).}

\item{subsample_beeswarm}{Integer or NULL. If set, subsample points for beeswarm plot.
NULL (default) means auto-determine based on dataset size.}

\item{quiet}{Logical. Suppress progress messages (default FALSE)}
}
\value{
List of class "mutateR_shap_analysis" containing:
\describe{
\item{model}{Trained XGBoost model}
\item{shap_values}{shapviz object with SHAP values}
\item{feature_importance}{Data frame of features ranked by importance}
\item{plots}{List of ggplot objects (beeswarm, bar, waterfall)}
\item{performance}{List with RÂ², RMSE, Spearman correlation}
\item{data}{List with features, targets, X matrix, y vector}
\item{metadata}{List with analysis parameters}
}
}
\description{
Uses a gradient boosting model with SHAP values to identify which sequence
features drive high scores and cross-method agreement/disagreement.
Supports tiered target variables for nuanced analysis.
}
\details{
The function performs the following steps:
\enumerate{
\item Aggregates gRNA data across all genes in batch_result
\item Extracts sequence features using \code{\link{extract_grna_features}}
\item Computes target variables using \code{\link{compute_shap_targets}}
\item Trains XGBoost model with cross-validation for early stopping
\item Computes SHAP values for feature importance
\item Generates visualization plots
}

XGBoost default parameters are tuned for gRNA data:
\itemize{
\item max_depth = 6 (moderate tree depth)
\item eta = 0.1 (learning rate)
\item subsample = 0.8 (row sampling)
\item colsample_bytree = 0.8 (feature sampling)
\item min_child_weight = 5 (minimum leaf size)
}
}
\examples{
\dontrun{
library(BSgenome.Hsapiens.UCSC.hg38)

# Run batch analysis
batch <- analyze_score_consensus(
  c("TP53", "BRCA1", "EGFR"),
  "hsapiens",
  BSgenome.Hsapiens.UCSC.hg38
)

# SHAP analysis for quality
shap_quality <- analyze_feature_importance(
  batch,
  target = "quality_percentile_modern"
)

# View results
print(shap_quality)
shap_quality$plots$beeswarm

# SHAP analysis for disagreement
shap_discord <- analyze_feature_importance(
  batch,
  target = "discordance_modern"
)
}

}
\seealso{
\code{\link{run_tiered_shap_analysis}} for multi-tier analysis,
\code{\link{extract_grna_features}} for feature computation,
\code{\link{compute_shap_targets}} for target variables
}
